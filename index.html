<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>å®çŸ³ã‚¿ãƒƒãƒ—ãƒ»ã‚¤ãƒ³ãƒ•ãƒ¬æ”¾ç½®ã‚²ãƒ¼ãƒ  v4</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
          "Segoe UI", sans-serif;
        background: #050608;
        color: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      #game {
        width: 100%;
        max-width: 480px;
        height: 100vh;
        max-height: 900px;
        display: flex;
        flex-direction: column;
        background: #141414;
      }

      header {
        padding: 10px 14px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        font-size: 14px;
        gap: 8px;
      }

      header .left {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }

      .money-row {
        display: flex;
        align-items: baseline;
        gap: 6px;
      }

      .money-label {
        font-size: 13px;
        opacity: 0.8;
      }

      .money-value {
        font-weight: bold;
        font-size: 20px;
      }

      .level-row {
        font-size: 12px;
        opacity: 0.9;
      }

      .xp-bar-container {
        width: 150px;
        height: 6px;
        background: #333;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 3px;
      }

      .xp-bar {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        width: 0%;
      }

      .stat-line {
        font-size: 11px;
        opacity: 0.9;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end;
        font-size: 11px;
      }

      .combo-indicator {
        text-align: right;
      }

      .combo-label {
        opacity: 0.8;
      }

      .combo-active {
        color: #ffca28;
        font-weight: 600;
      }

      .combo-none {
        opacity: 0.6;
      }

      .fever-indicator {
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 2px;
      }

      .fever-top {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .fever-label {
        font-size: 11px;
      }

      .fever-bar-container {
        width: 120px;
        height: 6px;
        background: #333;
        border-radius: 999px;
        overflow: hidden;
      }

      .fever-bar {
        height: 100%;
        background: linear-gradient(90deg, #ff7043, #ffca28);
        width: 0%;
      }

      #fever-btn {
        margin-top: 2px;
        padding: 2px 6px;
        font-size: 11px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        touch-action: manipulation;
        background: #555;
        color: #ddd;
      }

      #fever-btn.ready {
        background: linear-gradient(135deg, #ff7043, #ffb300);
        color: #212121;
        font-weight: 600;
      }

      #fever-btn.active {
        background: linear-gradient(135deg, #ffca28, #ffe082);
        color: #212121;
        font-weight: 700;
      }

      #field {
        position: relative;
        flex: 1;
        overflow: hidden;
        background: radial-gradient(circle at top, #283593, #0d1020);
      }

      #bottom {
        border-top: 1px solid #333;
        background: #181818;
      }

      #status-area {
        padding: 8px 14px;
        font-size: 12px;
        border-bottom: 1px solid #333;
        line-height: 1.4;
      }

      #status-main {
        margin-bottom: 2px;
      }

      #status-sub {
        opacity: 0.85;
      }

      #shop {
        padding: 8px 14px 10px;
        font-size: 12px;
      }

      #shop-title {
        font-size: 13px;
        margin-bottom: 4px;
        opacity: 0.9;
      }

      .shop-grid {
        display: flex;
        gap: 8px;
      }

      .shop-item {
        flex: 1;
        background: #232323;
        border-radius: 10px;
        padding: 6px 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .shop-item-title {
        font-size: 12px;
        font-weight: 600;
      }

      .shop-item-desc {
        font-size: 11px;
        opacity: 0.8;
      }

      .shop-item-info {
        font-size: 11px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .shop-item button {
        margin-top: 4px;
        padding: 4px 6px;
        font-size: 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        touch-action: manipulation;
        background: linear-gradient(135deg, #42a5f5, #1e88e5);
        color: #fff;
      }

      .shop-item button:disabled {
        background: #555;
        color: #bbb;
        cursor: default;
      }

      .gem {
        position: absolute;
        width: 60px;
        height: 60px;
        border-radius: 16px;
        border: none;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        color: #fff;
        cursor: pointer;
        touch-action: manipulation;
        box-shadow: 0 0 14px rgba(0, 0, 0, 0.7);
        transform: translate(-50%, -50%);
        transition: transform 0.06s ease-out;
      }

      .gem:active {
        transform: translate(-50%, -50%) scale(0.9);
      }

      .gem-normal {
        background: linear-gradient(135deg, #42a5f5, #1e88e5);
      }

      .gem-rare {
        background: linear-gradient(135deg, #ab47bc, #8e24aa);
      }

      .gem-epic {
        background: linear-gradient(135deg, #ffca28, #ffb300);
        color: #4e342e;
      }

      .gem-mythic {
        background: linear-gradient(135deg, #ff7043, #f4511e);
        color: #fff3e0;
      }

      .gem-bomb {
        background: radial-gradient(circle at 30% 20%, #ffeb3b, #d32f2f);
        color: #fffde7;
      }

      .badge {
        display: inline-block;
        padding: 1px 5px;
        border-radius: 999px;
        font-size: 10px;
        margin-left: 4px;
      }

      .badge-locked {
        background: #424242;
        color: #bdbdbd;
      }

      .badge-unlocked {
        background: #43a047;
        color: #f5f5f5;
      }

      .float-text {
        position: absolute;
        pointer-events: none;
        font-size: 14px;
        font-weight: 600;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
        opacity: 0;
        transform: translate(-50%, -50%);
        transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        z-index: 50;
      }

      .float-text-normal {
        color: #ffeb3b;
      }

      .float-text-crit {
        color: #ff5252;
        font-size: 16px;
      }

      .float-text-bomb {
        color: #ffa726;
      }
    </style>
  </head>
  <body>
    <div id="game">
      <header>
        <div class="left">
          <div class="money-row">
            <span class="money-label">æ‰€æŒé‡‘</span>
            <span class="money-value"><span id="money">0</span> G</span>
          </div>
          <div class="level-row">
            Lv.<span id="level">1</span>
            ï¼ˆXP: <span id="xp">0</span>/<span id="xp-max">100</span>ï¼‰
          </div>
          <div class="xp-bar-container">
            <div id="xp-bar" class="xp-bar"></div>
          </div>
          <div class="stat-line">
            TAP: <span id="tap-count">0</span> å› ï¼ Auto:
            <span id="auto-income">0</span> G/ç§’ ï¼ DPS:
            <span id="dps">0</span> G/ç§’
          </div>
        </div>

        <div class="right-panel">
          <div class="combo-indicator">
            <span class="combo-label">ã‚³ãƒ³ãƒœ:</span>
            <span id="combo" class="combo-none">x1.0</span>
          </div>
          <div class="fever-indicator">
            <div class="fever-top">
              <span>FEVER:</span>
              <span id="fever-label" class="fever-label">0%</span>
            </div>
            <div class="fever-bar-container">
              <div id="fever-bar" class="fever-bar"></div>
            </div>
            <button id="fever-btn" disabled>ç™ºå‹•</button>
          </div>
        </div>
      </header>

      <main id="field"></main>

      <div id="bottom">
        <div id="status-area">
          <div id="status-main">
            å®çŸ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãŠé‡‘ã¨XPã‚’é›†ã‚ã‚ˆã†ã€‚ã‚³ãƒ³ãƒœã¨FEVERã§ä¸€æ°—ã«ã‚¤ãƒ³ãƒ•ãƒ¬ï¼
          </div>
          <div id="status-sub"></div>
        </div>

        <section id="shop">
          <div id="shop-title">ã‚·ãƒ§ãƒƒãƒ—ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ï¼‰</div>
          <div class="shop-grid">
            <div class="shop-item">
              <div class="shop-item-title">å‡ºç¾é€Ÿåº¦ã‚¢ãƒƒãƒ—</div>
              <div class="shop-item-desc">
                å®çŸ³ã®å‡ºç¾é–“éš”ãŒçŸ­ããªã‚Šã€åŒæ™‚å‡ºç¾æ•°ã‚‚å¢—ãˆã‚„ã™ããªã‚‹ã€‚
              </div>
              <div class="shop-item-info">
                <span>Lv.<span id="spawn-level">0</span></span>
                <span>å¿…è¦: <span id="spawn-cost">200</span>G</span>
              </div>
              <button id="spawn-btn">è³¼å…¥</button>
            </div>

            <div class="shop-item">
              <div class="shop-item-title">ã‚ªãƒ¼ãƒˆæ¡æ˜æ©Ÿ</div>
              <div class="shop-item-desc">
                ä½•ã‚‚ã—ãªãã¦ã‚‚æ¯ç§’è‡ªå‹•ã§ãŠé‡‘ã‚’ç¨¼ã„ã§ãã‚Œã‚‹ã€‚
              </div>
              <div class="shop-item-info">
                <span>Lv.<span id="auto-level">0</span></span>
                <span>å¿…è¦: <span id="auto-cost">300</span>G</span>
              </div>
              <button id="auto-btn">è³¼å…¥</button>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      // ========= ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =========
      const state = {
        money: 0,
        totalTapCount: 0,
        level: 1,
        xp: 0,
        xpMax: 100,
        combo: 0,
        comboMultiplier: 1.0,
        comboTimeoutId: null,
        spawnUpgradeLevel: 0,
        autoMinerLevel: 0,
        feverGauge: 0,
        isFever: false,
        feverTimeoutId: null,
        lastMoneyForDps: 0,
        currentDps: 0,
      };

      // ========= å®çŸ³å®šç¾© =========
      const GEM_TYPES = [
        {
          id: "normal",
          name: "ãƒãƒ¼ãƒãƒ«",
          value: 10,
          unlockMoney: 0,
          cssClass: "gem-normal",
          icon: "â™¦",
        },
        {
          id: "rare",
          name: "ãƒ¬ã‚¢",
          value: 80,
          unlockMoney: 500,
          cssClass: "gem-rare",
          icon: "ğŸ’",
        },
        {
          id: "epic",
          name: "ã‚¨ãƒ”ãƒƒã‚¯",
          value: 500,
          unlockMoney: 5000,
          cssClass: "gem-epic",
          icon: "â­",
        },
        {
          id: "mythic",
          name: "ãƒŸã‚·ãƒƒã‚¯",
          value: 3000,
          unlockMoney: 50000,
          cssClass: "gem-mythic",
          icon: "ğŸ‘‘",
        },
      ];

      const BOMB_TYPE = {
        id: "bomb",
        name: "ãƒœãƒ ",
        value: 0,
        unlockLevel: 5,
        cssClass: "gem-bomb",
        icon: "ğŸ’£",
      };

      const BASE_SPAWN_INTERVAL_MS = 2500;

      // ========= è¦ç´ å‚ç…§ =========
      const moneyEl = document.getElementById("money");
      const levelEl = document.getElementById("level");
      const xpEl = document.getElementById("xp");
      const xpMaxEl = document.getElementById("xp-max");
      const xpBarEl = document.getElementById("xp-bar");
      const tapCountEl = document.getElementById("tap-count");
      const autoIncomeEl = document.getElementById("auto-income");
      const dpsEl = document.getElementById("dps");
      const comboEl = document.getElementById("combo");
      const fieldEl = document.getElementById("field");
      const statusMainEl = document.getElementById("status-main");
      const statusSubEl = document.getElementById("status-sub");

      const spawnLevelEl = document.getElementById("spawn-level");
      const spawnCostEl = document.getElementById("spawn-cost");
      const spawnBtn = document.getElementById("spawn-btn");

      const autoLevelEl = document.getElementById("auto-level");
      const autoCostEl = document.getElementById("auto-cost");
      const autoBtn = document.getElementById("auto-btn");

      const feverLabelEl = document.getElementById("fever-label");
      const feverBarEl = document.getElementById("fever-bar");
      const feverBtn = document.getElementById("fever-btn");

      // ========= æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ =========
      function formatBigNumber(value) {
        const abs = Math.abs(value);
        const units = [
          { v: 1e16, s: "äº¬" },
          { v: 1e12, s: "å…†" },
          { v: 1e8, s: "å„„" },
          { v: 1e4, s: "ä¸‡" },
        ];
        for (const u of units) {
          if (abs >= u.v) {
            return (value / u.v).toFixed(1).replace(/\.0$/, "") + u.s;
          }
        }
        return value.toLocaleString("ja-JP");
      }

      // ========= ã‚³ãƒ³ãƒœé–¢é€£ =========
      function maxComboMultiplier() {
        // LvãŒä¸ŠãŒã‚‹ã»ã©ä¸Šé™UPã€æœ€å¤§10å€
        return Math.min(10, 2 + (state.level - 1) * 0.3);
      }

      function resetCombo() {
        state.combo = 0;
        state.comboMultiplier = 1.0;
        comboEl.textContent = "x1.0";
        comboEl.classList.remove("combo-active");
        comboEl.classList.add("combo-none");
      }

      function addCombo() {
        state.combo += 1;
        const raw = 1 + 0.15 * state.combo;
        state.comboMultiplier = Math.min(maxComboMultiplier(), raw);
        comboEl.textContent = "x" + state.comboMultiplier.toFixed(1);
        comboEl.classList.remove("combo-none");
        comboEl.classList.add("combo-active");

        if (state.comboTimeoutId) clearTimeout(state.comboTimeoutId);
        state.comboTimeoutId = setTimeout(resetCombo, 1500);
      }

      // ========= FEVERï¼ˆã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¢ãƒ¼ãƒ‰ï¼‰ =========
      function levelValueMultiplier() {
        // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ä¾¡å€¤ãŒã©ã‚“ã©ã‚“ã‚¤ãƒ³ãƒ•ãƒ¬
        return 1 + (state.level - 1) * 0.35;
      }

      function feverValueMultiplier() {
        // ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã£ã¦ãƒ•ã‚§ãƒ¼ãƒãƒ¼å€ç‡ã‚‚å°‘ã—ãšã¤ä¸Šæ˜‡
        if (!state.isFever) return 1.0;
        const base = 2;
        const bonus = Math.floor((state.level - 1) / 10) * 0.5; // 10Lvã”ã¨ã«+0.5
        return base + bonus;
      }

      function totalValueMultiplier() {
        return levelValueMultiplier() * feverValueMultiplier();
      }

      function updateFeverUI() {
        const gauge = Math.round(state.feverGauge);
        feverLabelEl.textContent = `${gauge}%`;
        feverBarEl.style.width = `${Math.min(100, gauge)}%`;

        feverBtn.disabled = true;
        feverBtn.classList.remove("ready", "active");

        if (state.isFever) {
          feverBtn.disabled = false;
          feverBtn.classList.add("active");
          feverBtn.textContent = "FEVERä¸­";
        } else if (gauge >= 100) {
          feverBtn.disabled = false;
          feverBtn.classList.add("ready");
          feverBtn.textContent = "FEVER!";
        } else {
          feverBtn.textContent = "ç™ºå‹•";
        }
      }

      function addFeverGauge(amount) {
        if (state.isFever) return;
        state.feverGauge = Math.min(100, state.feverGauge + amount);
        updateFeverUI();
      }

      function endFever() {
        state.isFever = false;
        state.feverGauge = 0;
        if (state.feverTimeoutId) state.feverTimeoutId = null;
        statusMainEl.textContent = "ãƒ•ã‚£ãƒ¼ãƒãƒ¼çµ‚äº†ï¼ã¾ãŸã‚²ãƒ¼ã‚¸ã‚’ãŸã‚ã¦ç™ºå‹•ã—ã‚ˆã†ã€‚";
        updateFeverUI();
        restartSpawnTimer();
      }

      function startFever() {
        if (state.isFever || state.feverGauge < 100) return;
        state.isFever = true;
        statusMainEl.textContent =
          "FEVER!! å®çŸ³ä¾¡å€¤ï¼†å‡ºç¾é€Ÿåº¦ãŒå¤§å¹…ã‚¢ãƒƒãƒ—ä¸­ï¼é€£æ‰“ã§ä¸€æ°—ã«ã‚¤ãƒ³ãƒ•ãƒ¬ï¼";
        updateFeverUI();
        restartSpawnTimer();

        if (state.feverTimeoutId) clearTimeout(state.feverTimeoutId);
        state.feverTimeoutId = setTimeout(endFever, 10000); // 10ç§’
      }

      feverBtn.addEventListener("click", () => {
        if (!state.isFever && state.feverGauge >= 100) {
          startFever();
        }
      });

      // ========= ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«é–¢é€£ =========
      function getCritChance() {
        // ãƒ™ãƒ¼ã‚¹5% + ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¢—åŠ ï¼ˆæœ€å¤§50%ï¼‰
        const base = 0.05;
        const fromLevel = (state.level - 1) * 0.004;
        return Math.min(0.5, base + fromLevel);
      }

      function getCritMultiplier() {
        // LvãŒä¸ŠãŒã‚‹ã»ã©æœ€å¤§å€ç‡ã‚‚å¢—åŠ ï¼ˆæœ€å¤§20å€ï¼‰
        const min = 2;
        const maxBase = 4 + state.level * 0.4; // Lv10ã§8å€, Lv20ã§12å€â€¦
        const max = Math.min(20, maxBase);
        return min + Math.random() * (max - min);
      }

      // ========= æµ®éŠãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡º =========
      function showFloatingText(text, x, y, type) {
        const rect = fieldEl.getBoundingClientRect();
        const el = document.createElement("div");
        el.className = "float-text " + type;
        el.textContent = text;
        el.style.left = x + "px";
        el.style.top = y + "px";
        fieldEl.appendChild(el);

        requestAnimationFrame(() => {
          el.style.opacity = "1";
          el.style.transform = "translate(-50%, -80%)";
        });

        setTimeout(() => {
          el.style.opacity = "0";
          el.style.transform = "translate(-50%, -120%)";
          setTimeout(() => el.remove(), 500);
        }, 300);
      }

      function getPointerPositionInField(event) {
        const rect = fieldEl.getBoundingClientRect();
        let clientX = 0;
        let clientY = 0;
        if (event.touches && event.touches[0]) {
          clientX = event.touches[0].clientX;
          clientY = event.touches[0].clientY;
        } else if (event.changedTouches && event.changedTouches[0]) {
          clientX = event.changedTouches[0].clientX;
          clientY = event.changedTouches[0].clientY;
        } else {
          clientX = event.clientX;
          clientY = event.clientY;
        }
        return {
          x: clientX - rect.left,
          y: clientY - rect.top,
        };
      }

      // ========= æ‰€æŒé‡‘ / XP / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–° =========
      function addMoney(baseGain, gemName, options = {}) {
        const { isCrit = false, critMultiplier = 1, isBomb = false, pos } =
          options;

        let gain =
          baseGain * state.comboMultiplier * totalValueMultiplier() * critMultiplier;
        gain = Math.floor(gain);
        if (gain <= 0) return 0;

        state.money += gain;
        moneyEl.textContent = formatBigNumber(state.money);

        let mainText = `${gemName} ã‚’ã‚¿ãƒƒãƒ—ï¼ +${formatBigNumber(gain)}G`;
        if (isBomb) {
          mainText = `ãƒœãƒ ç‚¸è£‚ï¼å‘¨å›²ã®å®çŸ³ã‚’ã¾ã¨ã‚ã¦ç ´å£Šï¼ +${formatBigNumber(
            gain
          )}G`;
        } else {
          const parts = [];
          parts.push(`ã‚³ãƒ³ãƒœ x${state.comboMultiplier.toFixed(1)}`);
          parts.push(`ãƒ¬ãƒ™ãƒ«è£œæ­£ x${levelValueMultiplier().toFixed(1)}`);
          if (state.isFever) parts.push(`FEVER x${feverValueMultiplier().toFixed(1)}`);
          if (isCrit) parts.push(`CRIT x${critMultiplier.toFixed(1)}`);
          mainText += `ï¼ˆ${parts.join("ï¼")}ï¼‰`;
        }

        statusMainEl.textContent = mainText;

        // æµ®éŠãƒ†ã‚­ã‚¹ãƒˆ
        if (pos) {
          const floatType = isBomb
            ? "float-text-bomb"
            : isCrit
            ? "float-text-crit"
            : "float-text-normal";
          const label = (isCrit ? "CRIT!! " : "") + `+${formatBigNumber(gain)}G`;
          showFloatingText(label, pos.x, pos.y, floatType);
        }

        updateUnlockStatusText();
        updateShopButtons();
        return gain;
      }

      function addXp(amount) {
        state.xp += amount;
        while (state.xp >= state.xpMax) {
          state.xp -= state.xpMax;
          state.level += 1;
          state.xpMax = Math.floor(state.xpMax * 1.5);
          statusSubEl.textContent = `ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ Lv.${state.level}ã€‚å®çŸ³ä¾¡å€¤ã¨FEVERç«åŠ›ãŒã•ã‚‰ã«ã‚¤ãƒ³ãƒ•ãƒ¬ï¼`;
        }

        levelEl.textContent = state.level;
        xpEl.textContent = state.xp;
        xpMaxEl.textContent = state.xpMax;
        const ratio = (state.xp / state.xpMax) * 100;
        xpBarEl.style.width = `${Math.min(100, ratio)}%`;

        restartSpawnTimer();
      }

      function updateStats() {
        tapCountEl.textContent = state.totalTapCount;
        const baseAuto = state.autoMinerLevel * 5;
        const displayAuto = Math.floor(baseAuto * levelValueMultiplier());
        autoIncomeEl.textContent = formatBigNumber(displayAuto);
        dpsEl.textContent = formatBigNumber(state.currentDps);
      }

      function updateUnlockStatusText() {
        const locked = GEM_TYPES.filter((g) => state.money < g.unlockMoney);
        const lines = GEM_TYPES.map((g) => {
          const unlocked = state.money >= g.unlockMoney;
          const condition =
            g.unlockMoney === 0
              ? "æœ€åˆã‹ã‚‰å‡ºç¾"
              : `${formatBigNumber(g.unlockMoney)}G ä»¥ä¸Šã§å‡ºç¾`;
          const badge = `<span class="badge ${
            unlocked ? "badge-unlocked" : "badge-locked"
          }">${unlocked ? "è§£æ”¾æ¸ˆ" : "æœªè§£æ”¾"}</span>`;
          return `${g.name}ï¼ˆåŸºç¤ +${g.value.toLocaleString(
            "ja-JP"
          )}Gï¼‰: ${condition} ${badge}`;
        });

        if (locked.length > 0) {
          locked.sort((a, b) => a.unlockMoney - b.unlockMoney);
          const next = locked[0];
          statusSubEl.innerHTML =
            `<div>æ¬¡ã®ãƒ¬ã‚¢å®çŸ³: <strong>${next.name}</strong>ï¼ˆ${formatBigNumber(
              next.unlockMoney
            )}G ã§è§£æ”¾ï¼‰</div>` +
            `<div style="margin-top:4px;">${lines.join("<br>")}</div>`;
        } else {
          statusSubEl.innerHTML =
            `<div>ã™ã¹ã¦ã®å®çŸ³ã‚’è§£æ”¾ã—ã¾ã—ãŸï¼</div>` +
            `<div style="margin-top:4px;">${lines.join("<br>")}</div>`;
        }
      }

      // ========= å®çŸ³å‡ºç¾é–¢é€£ =========
      function getUnlockedGemTypes() {
        return GEM_TYPES.filter((g) => state.money >= g.unlockMoney);
      }

      function currentSpawnInterval() {
        const levelFactor = Math.max(0.25, 1 - (state.level - 1) * 0.04);
        const upgradeFactor = Math.pow(0.8, state.spawnUpgradeLevel);
        const feverFactor = state.isFever ? 0.4 : 1.0;
        return BASE_SPAWN_INTERVAL_MS * levelFactor * upgradeFactor * feverFactor;
      }

      function currentGemLimit() {
        // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦æœ€å¤§150ã¾ã§å¢—åŠ 
        return Math.min(40 + state.level * 6, 150);
      }

      let spawnTimerId = null;

      function restartSpawnTimer() {
        if (spawnTimerId) clearInterval(spawnTimerId);
        const interval = Math.max(200, currentSpawnInterval());
        spawnTimerId = setInterval(spawnGem, interval);
      }

      function spawnGem() {
        const currentGemCount = fieldEl.querySelectorAll(".gem").length;
        if (currentGemCount >= currentGemLimit()) return;

        const candidates = getUnlockedGemTypes();
        if (candidates.length === 0) return;

        let gemType;
        const canSpawnBomb = state.level >= BOMB_TYPE.unlockLevel;
        const bombChance = canSpawnBomb ? 0.07 : 0; // 7%ã§ãƒœãƒ å‡ºç¾
        if (Math.random() < bombChance) {
          gemType = BOMB_TYPE;
        } else {
          gemType =
            candidates[Math.floor(Math.random() * candidates.length)];
        }

        const gemEl = document.createElement("button");
        gemEl.className = `gem ${gemType.cssClass}`;
        gemEl.innerHTML = gemType.icon;

        const leftPercent = 8 + Math.random() * 84;
        const topPercent = 8 + Math.random() * 84;
        gemEl.style.left = leftPercent + "%";
        gemEl.style.top = topPercent + "%";

        // å„å®çŸ³ã®åŸºç¤ä¾¡å€¤ã‚’ä¿æŒï¼ˆãƒœãƒ ç”¨ï¼‰
        gemEl.dataset.baseValue = gemType.value;
        gemEl.dataset.gemName = gemType.name;
        gemEl.dataset.gemId = gemType.id;

        const onTap = (event) => {
          event.preventDefault();
          if (!fieldEl.contains(gemEl)) return;
          const pos = getPointerPositionInField(event);

          if (gemType.id === "bomb") {
            handleBombTap(gemEl, pos);
          } else {
            handleNormalGemTap(gemEl, gemType, pos);
          }
        };

        gemEl.addEventListener("click", onTap);
        gemEl.addEventListener("touchstart", onTap, { passive: false });

        fieldEl.appendChild(gemEl);

        setTimeout(() => {
          if (gemEl.isConnected) gemEl.remove();
        }, 10000);
      }

      function handleNormalGemTap(gemEl, gemType, pos) {
        gemEl.remove();

        addCombo();
        addFeverGauge(5); // 1ã‚¿ãƒƒãƒ—ã§5%ï¼ˆ20ãƒ’ãƒƒãƒˆã§FEVERï¼‰

        state.totalTapCount += 1;
        updateStats();

        // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š
        const critChance = getCritChance();
        const isCrit = Math.random() < critChance;
        const critMultiplier = isCrit ? getCritMultiplier() : 1;

        const gainedMoney = addMoney(gemType.value, gemType.name, {
          isCrit,
          critMultiplier,
          isBomb: false,
          pos,
        });

        addXp(Math.floor(gainedMoney / 3));
      }

      function handleBombTap(bombEl, pos) {
        // å…ˆã«ãƒœãƒ ã‚’æ¶ˆã™
        bombEl.remove();

        addCombo();
        addFeverGauge(10); // ãƒœãƒ ã§ä¸€æ°—ã«ã‚²ãƒ¼ã‚¸UP
        state.totalTapCount += 1;

        const fieldRect = fieldEl.getBoundingClientRect();

        // ã‚¿ãƒƒãƒ—ä½ç½®ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å†…åº§æ¨™ï¼‰ã‚’çˆ†å¿ƒåœ°ã¨ã™ã‚‹
        const centerX = fieldRect.left + pos.x;
        const centerY = fieldRect.top + pos.y;

        const gems = Array.from(fieldEl.querySelectorAll(".gem"));

        // çˆ†é¢¨åŠå¾„ï¼ˆã¡ã‚‡ã£ã¨åºƒã‚ã«ï¼‰
        const radius = 200;

        let totalBaseValue = 0;
        let destroyedCount = 0;

        // ã€Œä¸€ç•ªè¿‘ã„å®çŸ³ã€ã¯å¿…ãšå·»ãè¾¼ã‚€ãŸã‚ã«è¨˜éŒ²ã—ã¦ãŠã
        let nearestGem = null;
        let nearestDist = Infinity;

        gems.forEach((g) => {
          if (g === bombEl) return;

          const r = g.getBoundingClientRect();
          const gx = r.left + r.width / 2;
          const gy = r.top + r.height / 2;

          const dx = gx - centerX;
          const dy = gy - centerY;
          const dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < nearestDist) {
            nearestDist = dist;
            nearestGem = g;
          }

          // åŠå¾„å†…ãªã‚‰çˆ†ç ´å¯¾è±¡
          if (dist <= radius) {
            const baseValue = parseFloat(g.dataset.baseValue || "0");
            if (!isNaN(baseValue) && baseValue > 0) {
              totalBaseValue += baseValue;
              destroyedCount += 1;
            }
            g.remove();
          }
        });

        // åŠå¾„å†…ã«èª°ã‚‚ã„ãªã‹ã£ãŸå ´åˆã§ã‚‚ã€
        // ä¸€ç•ªè¿‘ã„å®çŸ³ã ã‘ã¯å·»ãè¾¼ã‚€ã‚ˆã†ã«ã™ã‚‹
        if (destroyedCount === 0 && nearestGem) {
          const baseValue = parseFloat(nearestGem.dataset.baseValue || "0");
          if (!isNaN(baseValue) && baseValue > 0) {
            totalBaseValue += baseValue;
            destroyedCount = 1;
          }
          nearestGem.remove();
        }

        // çˆ†ç ´å¯¾è±¡ã‚¼ãƒ­ãªã‚‰ãã®ã¾ã¾çµ‚äº†
        if (destroyedCount === 0 || totalBaseValue <= 0) {
          statusMainEl.textContent =
            "ãƒœãƒ ã‚’èµ·çˆ†ã—ãŸãŒã€å·»ãè¾¼ã¾ã‚ŒãŸå®çŸ³ã¯ãªã‹ã£ãŸâ€¦";
          updateStats();
          return;
        }

        // å¹³å‡åŸºç¤ä¾¡å€¤ Ã— å€‹æ•° ã‚’ãƒ™ãƒ¼ã‚¹ã«ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—
        const avgBase = totalBaseValue / destroyedCount;

        // ãƒœãƒ ç”¨ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ˆå°‘ã—æ§ãˆã‚ï¼‰
        const critChance = getCritChance() * 0.5;
        const isCrit = Math.random() < critChance;
        const critMultiplier = isCrit ? getCritMultiplier() : 1;

        const centerPos = { x: pos.x, y: pos.y };

        const gainedMoney = addMoney(avgBase * destroyedCount, "ãƒœãƒ ", {
          isCrit,
          critMultiplier,
          isBomb: true,
          pos: centerPos,
        });

        addXp(Math.floor(gainedMoney / 4));
        updateStats();
      }


      // ========= ã‚ªãƒ¼ãƒˆæ¡æ˜æ©Ÿ =========
      function autoMinerTick() {
        if (state.autoMinerLevel <= 0) return;
        let gain = state.autoMinerLevel * 5;
        gain = Math.floor(gain * totalValueMultiplier());
        if (gain <= 0) return;
        state.money += gain;
        moneyEl.textContent = formatBigNumber(state.money);
        updateUnlockStatusText();
        updateShopButtons();
      }

      // ========= DPSè¨ˆæ¸¬ =========
      function dpsTick() {
        const diff = state.money - state.lastMoneyForDps;
        state.currentDps = diff;
        state.lastMoneyForDps = state.money;
        updateStats();
      }

      // ========= ã‚·ãƒ§ãƒƒãƒ—é–¢é€£ =========
      function spawnUpgradeCost(level) {
        return 200 * Math.pow(2, level); // 200, 400, 800, ...
      }

      function autoUpgradeCost(level) {
        return 300 * Math.pow(1.1, level); // 300, 600, 1200, ...
      }

      function updateShopButtons() {
        const spawnCost = spawnUpgradeCost(state.spawnUpgradeLevel);
        const autoCost = autoUpgradeCost(state.autoMinerLevel);

        spawnCostEl.textContent = formatBigNumber(spawnCost);
        autoCostEl.textContent = formatBigNumber(autoCost);

        spawnLevelEl.textContent = state.spawnUpgradeLevel;
        autoLevelEl.textContent = state.autoMinerLevel;

        spawnBtn.disabled = state.money < spawnCost;
        autoBtn.disabled = state.money < autoCost;
      }

      spawnBtn.addEventListener("click", () => {
        const cost = spawnUpgradeCost(state.spawnUpgradeLevel);
        if (state.money < cost) return;
        state.money -= cost;
        moneyEl.textContent = formatBigNumber(state.money);
        state.spawnUpgradeLevel += 1;
        statusMainEl.textContent = `å‡ºç¾é€Ÿåº¦ã‚¢ãƒƒãƒ— Lv.${state.spawnUpgradeLevel} ã‚’è³¼å…¥ï¼ç”»é¢ãŒã©ã‚“ã©ã‚“å®çŸ³ã¾ã¿ã‚Œã«ï¼`;
        updateShopButtons();
        restartSpawnTimer();
      });

      autoBtn.addEventListener("click", () => {
        const cost = autoUpgradeCost(state.autoMinerLevel);
        if (state.money < cost) return;
        state.money -= cost;
        moneyEl.textContent = formatBigNumber(state.money);
        state.autoMinerLevel += 1;
        statusMainEl.textContent = `ã‚ªãƒ¼ãƒˆæ¡æ˜æ©Ÿ Lv.${state.autoMinerLevel} ã‚’è³¼å…¥ï¼æ”¾ç½®ã§ã‚‚ã‚¬ãƒ³ã‚¬ãƒ³è²¯ã¾ã‚‹ï¼`;
        updateStats();
        updateShopButtons();
      });

      // ========= åˆæœŸåŒ– =========
      function init() {
        moneyEl.textContent = formatBigNumber(state.money);
        levelEl.textContent = state.level;
        xpEl.textContent = state.xp;
        xpMaxEl.textContent = state.xpMax;
        xpBarEl.style.width = "0%";
        resetCombo();
        updateUnlockStatusText();
        updateShopButtons();
        updateFeverUI();
        updateStats();

        statusMainEl.textContent =
          "æ™‚é–“ãŒçµŒã¤ã¨å®çŸ³ãŒå‡ºç¾ã—ã¾ã™ã€‚ã‚¿ãƒƒãƒ—é€£æ‰“ã¨ãƒœãƒ ãƒ»FEVERã§ç”»é¢ã‚’ã¶ã£å£Šãã†ï¼";

        restartSpawnTimer();
        setInterval(autoMinerTick, 1000);
        setInterval(dpsTick, 1000);
      }

      init();
    </script>
  </body>
</html>
